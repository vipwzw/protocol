#!/bin/bash

# Pre-commit hook: é˜²æ­¢æäº¤å¤§æ–‡ä»¶å’Œä¸å½“æ–‡ä»¶
# 
# å®‰è£…æ–¹æ³•ï¼š
# 1. è‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰: npm run setup-hooks
# 2. æ‰‹åŠ¨å®‰è£…: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# é…ç½®
MAX_FILE_SIZE=10485760  # 10MB in bytes
MAX_FILE_SIZE_MB=10     # ç”¨äºæ˜¾ç¤º

echo -e "${GREEN}ğŸ” æ‰§è¡Œæäº¤å‰æ£€æŸ¥...${NC}"

# è·å–å°†è¦æäº¤çš„æ–‡ä»¶åˆ—è¡¨
files=$(git diff --cached --name-only --diff-filter=ACM)

# å¦‚æœæ²¡æœ‰æ–‡ä»¶è¦æäº¤ï¼Œç›´æ¥é€šè¿‡
if [ -z "$files" ]; then
    exit 0
fi

# æ ‡è®°æ˜¯å¦å‘ç°é—®é¢˜
found_issues=0
large_files=""
build_info_files=""
suspicious_files=""

# æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶
while IFS= read -r file; do
    # è·³è¿‡å·²åˆ é™¤çš„æ–‡ä»¶
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # è·å–æ–‡ä»¶å¤§å°
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        file_size=$(stat -f%z "$file" 2>/dev/null)
    else
        # Linux
        file_size=$(stat -c%s "$file" 2>/dev/null)
    fi
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    if [ -n "$file_size" ] && [ "$file_size" -gt "$MAX_FILE_SIZE" ]; then
        # è½¬æ¢ä¸º MB
        if command -v bc &> /dev/null; then
            size_mb=$(echo "scale=2; $file_size / 1048576" | bc)
        else
            size_mb=$((file_size / 1048576))
        fi
        large_files="${large_files}\n  âŒ $file (${size_mb}MB)"
        found_issues=1
    fi
    
    # æ£€æŸ¥ build-info æ–‡ä»¶
    if echo "$file" | grep -qE "artifacts/build-info/.*\.json$"; then
        build_info_files="${build_info_files}\n  âŒ $file"
        found_issues=1
    fi
    
    # æ£€æŸ¥å…¶ä»–ä¸åº”è¯¥æäº¤çš„æ–‡ä»¶
    case "$file" in
        *node_modules/*|*.log|*coverage/*|*dist/*|*build/*|*.tmp|*.bak|.DS_Store|.env|.env.*)
            suspicious_files="${suspicious_files}\n  âš ï¸  $file"
            ;;
    esac
done <<< "$files"

# æŠ¥å‘Šé—®é¢˜
if [ -n "$large_files" ]; then
    echo -e "\n${RED}âŒ å‘ç°å¤§äº ${MAX_FILE_SIZE_MB}MB çš„æ–‡ä»¶ï¼š${NC}"
    echo -e "$large_files"
fi

if [ -n "$build_info_files" ]; then
    echo -e "\n${RED}âŒ å‘ç° build-info æ–‡ä»¶ï¼š${NC}"
    echo -e "$build_info_files"
    echo -e "${YELLOW}è¿™äº›æ–‡ä»¶ä¸åº”è¯¥è¢«æäº¤ã€‚è¯·ç¡®ä¿ .gitignore åŒ…å«: **/artifacts/build-info/${NC}"
fi

if [ -n "$suspicious_files" ]; then
    echo -e "\n${YELLOW}âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ°å¯èƒ½ä¸åº”è¯¥æäº¤çš„æ–‡ä»¶ï¼š${NC}"
    echo -e "$suspicious_files"
fi

# å¦‚æœå‘ç°ä¸¥é‡é—®é¢˜ï¼Œé˜»æ­¢æäº¤
if [ "$found_issues" -eq 1 ]; then
    echo -e "\n${RED}âŒ æäº¤è¢«é˜»æ­¢${NC}"
    echo -e "\n${GREEN}å»ºè®®ï¼š${NC}"
    echo "1. å¯¹äºå¤§æ–‡ä»¶ï¼š"
    echo "   - ä½¿ç”¨ Git LFS: git lfs track '<pattern>'"
    echo "   - æˆ–æ·»åŠ åˆ° .gitignore"
    echo ""
    echo "2. ä»æš‚å­˜åŒºç§»é™¤æ–‡ä»¶ï¼š"
    echo "   git reset HEAD <file>"
    echo ""
    echo "3. å¦‚æœç¡®å®éœ€è¦æäº¤ï¼Œå¯ä»¥è·³è¿‡æ£€æŸ¥ï¼š"
    echo "   git commit --no-verify"
    echo ""
    exit 1
fi

# é¢å¤–æ£€æŸ¥ï¼šæ–‡ä»¶åè§„èŒƒ
echo -e "${GREEN}âœ… æ–‡ä»¶å¤§å°æ£€æŸ¥é€šè¿‡${NC}"

# æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
if command -v grep &> /dev/null; then
    sensitive_patterns=(
        "password.*=.*['\"]"
        "api[_-]?key.*=.*['\"]"
        "secret.*=.*['\"]"
        "private[_-]?key"
    )
    
    for pattern in "${sensitive_patterns[@]}"; do
        matches=$(git diff --cached --name-only | xargs grep -l -i "$pattern" 2>/dev/null || true)
        if [ -n "$matches" ]; then
            echo -e "\n${YELLOW}âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼š${NC}"
            echo "$matches"
            echo "è¯·ç¡®è®¤è¿™äº›æ˜¯å¦åº”è¯¥æäº¤ã€‚"
        fi
    done
fi

echo -e "${GREEN}âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡${NC}"
exit 0 