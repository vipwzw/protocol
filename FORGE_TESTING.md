# ğŸ”§ Forgeæµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®å·²é…ç½®äº†å®Œæ•´çš„Forgeæµ‹è¯•ç¯å¢ƒï¼Œæ”¯æŒæ‰€æœ‰åˆçº¦åŒ…çš„å•å…ƒæµ‹è¯•ã€‚æ‰€æœ‰æµ‹è¯•éƒ½å¯ä»¥åœ¨æ ¹ç›®å½•é€šè¿‡yarnå‘½ä»¤è¿è¡Œã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨å¯åŠ¨HardhatèŠ‚ç‚¹
```bash
# 1. å¯åŠ¨HardhatèŠ‚ç‚¹ï¼ˆåœ¨å•ç‹¬çš„ç»ˆç«¯ä¸­ï¼‰
npx hardhat node

# 2. è¿è¡Œæ‰€æœ‰Forgeæµ‹è¯•
yarn test:forge
```

### æ–¹æ³•äºŒï¼šè‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
# è‡ªåŠ¨å¯åŠ¨HardhatèŠ‚ç‚¹å¹¶è¿è¡Œæµ‹è¯•
yarn test:forge:auto
```

## ğŸ“‹ å¯ç”¨å‘½ä»¤

| å‘½ä»¤ | æè¿° | ç”¨é€” |
|------|------|------|
| `yarn test:forge` | è¿è¡Œæ‰€æœ‰Forgeæµ‹è¯• | éœ€è¦æ‰‹åŠ¨å¯åŠ¨HardhatèŠ‚ç‚¹ |
| `yarn test:forge:auto` | è‡ªåŠ¨å¯åŠ¨èŠ‚ç‚¹å¹¶è¿è¡Œæµ‹è¯• | ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯• |
| `yarn test:forge:run` | ä»…è¿è¡Œæµ‹è¯•ï¼ˆä¸å¯åŠ¨èŠ‚ç‚¹ï¼‰ | èŠ‚ç‚¹å·²è¿è¡Œæ—¶ä½¿ç”¨ |
| `yarn test:forge:prepare` | æ˜¾ç¤ºèŠ‚ç‚¹å¯åŠ¨æç¤º | å¸®åŠ©ä¿¡æ¯ |

## ğŸ“Š æµ‹è¯•è¦†ç›–

### åˆçº¦åŒ…æµ‹è¯•çŠ¶æ€

| åŒ…å | æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|------|----------|----------|------|
| **utils** | `LibBytesTest.t.sol` | 4ä¸ª | âœ… |
| **exchange-libs** | `LibMath.t.sol` | 3ä¸ª | âœ… |
| **governance** | å¤šä¸ªæµ‹è¯•æ–‡ä»¶ | 59ä¸ª | âœ… |
| **erc20** | `ZRXToken.t.sol` | 9ä¸ª | âœ… |
| **erc721** | `ERC721Token.t.sol` | 12ä¸ª | âœ… |
| **erc1155** | `ERC1155.t.sol` | 11ä¸ª | âœ… |
| **asset-proxy** | `ERC20Proxy.t.sol` | 9ä¸ª | âœ… |
| **staking** | `StakingBasic.t.sol` | 9ä¸ª | âœ… |
| **treasury** | `SimpleTreasury.t.sol` | 8ä¸ª | âœ… |
| **zero-ex** | æµ‹è¯•æ–‡ä»¶ | 2ä¸ª | âœ… |

**æ€»è®¡ï¼š126ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼** ğŸ‰

## ğŸ” å•ä¸ªåŒ…æµ‹è¯•

å¦‚æœæ‚¨éœ€è¦æµ‹è¯•ç‰¹å®šçš„åŒ…ï¼š

```bash
# è¿›å…¥åŒ…ç›®å½•
cd contracts/utils

# è¿è¡Œè¯¥åŒ…çš„forgeæµ‹è¯•
forge test

# æˆ–ä½¿ç”¨yarnå‘½ä»¤
yarn test:forge
```

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### Hardhaté…ç½®
```typescript
networks: {
    hardhat: {
        chainId: 1337,
        accounts: { count: 20 },
        gasPrice: 1337,
        initialBaseFeePerGas: 0,
        blockGasLimit: 30000000,
    },
    localhost: {
        url: 'http://localhost:8545',
    },
}
```

### Foundryé…ç½®
- Solidityç‰ˆæœ¬ï¼š0.8.28
- EVMç‰ˆæœ¬ï¼šshanghai
- ä¼˜åŒ–å™¨ï¼šå¯ç”¨ï¼Œruns=1000000
- æµ‹è¯•ç›®å½•ï¼š`tests/`ï¼ˆæ ‡å‡†åŒ–ï¼‰

### ç‰¹æ®Šå¤„ç†
- **governanceåŒ…**ï¼šè‡ªåŠ¨æ’é™¤éœ€è¦å¤–éƒ¨RPCçš„E2Eæµ‹è¯•
- **mockåˆçº¦**ï¼šä¸ºç®€åŒ–ä¾èµ–è€Œåˆ›å»ºçš„æµ‹è¯•ç”¨mock
- **æ ‡å‡†åŒ–**ï¼šæ‰€æœ‰åŒ…ä½¿ç”¨ç»Ÿä¸€çš„æµ‹è¯•ç›®å½•ç»“æ„

## ğŸ› ï¸ å¼€å‘å·¥ä½œæµ

### æ·»åŠ æ–°æµ‹è¯•
1. åœ¨`contracts/[åŒ…å]/tests/`ç›®å½•ä¸‹åˆ›å»º`.t.sol`æ–‡ä»¶
2. ä½¿ç”¨æ ‡å‡†çš„Forgeæµ‹è¯•æ ¼å¼
3. è¿è¡Œ`yarn test:forge`éªŒè¯

### è°ƒè¯•æµ‹è¯•
```bash
# è¯¦ç»†è¾“å‡º
cd contracts/[åŒ…å]
forge test -vvv

# è¿è¡Œç‰¹å®šæµ‹è¯•
forge test --match-test testSpecificFunction
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä½¿ç”¨mockåˆçº¦**ï¼šå‡å°‘å¤–éƒ¨ä¾èµ–ï¼Œæé«˜æµ‹è¯•ç¨³å®šæ€§
2. **éµå¾ªå‘½åçº¦å®š**ï¼šæµ‹è¯•å‡½æ•°ä»¥`test`å¼€å¤´
3. **æ–­è¨€æ¸…æ™°**ï¼šä½¿ç”¨æè¿°æ€§çš„æ–­è¨€æ¶ˆæ¯
4. **æµ‹è¯•éš”ç¦»**ï¼šæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çŠ¶æ€
5. **è¦†ç›–è¾¹ç•Œæƒ…å†µ**ï¼šæµ‹è¯•æ­£å¸¸æµç¨‹å’Œé”™è¯¯æƒ…å†µ

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. "No tests found"**
- ç¡®ä¿æµ‹è¯•æ–‡ä»¶åœ¨`tests/`ç›®å½•ä¸‹
- æ£€æŸ¥å‡½æ•°åæ˜¯å¦ä»¥`test`å¼€å¤´

**2. "Hardhat node connection failed"**
- ç¡®ä¿HardhatèŠ‚ç‚¹å·²å¯åŠ¨ï¼š`npx hardhat node`
- æ£€æŸ¥ç«¯å£8545æ˜¯å¦è¢«å ç”¨

**3. "Compilation failed"**
- æ£€æŸ¥Solidityç‰ˆæœ¬å…¼å®¹æ€§
- ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼š`yarn install`

**4. Importè·¯å¾„é”™è¯¯**
- ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„remappingé…ç½®
- æ£€æŸ¥ç›¸å¯¹è·¯å¾„æ˜¯å¦æ­£ç¡®

### è°ƒè¯•å‘½ä»¤
```bash
# æ£€æŸ¥forgeç‰ˆæœ¬
forge --version

# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
forge clean && forge build

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
forge test -vvv
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡Œè¿è¡Œ**ï¼šä½¿ç”¨`wsrun --serial`ç¡®ä¿ç¨³å®šæ€§
- **ç¼“å­˜åˆ©ç”¨**ï¼šForgeè‡ªåŠ¨ç¼“å­˜ç¼–è¯‘ç»“æœ
- **é€‰æ‹©æ€§æµ‹è¯•**ï¼šä½¿ç”¨`--match-path`è¿è¡Œç‰¹å®šæµ‹è¯•

## ğŸ¤– CI/CD é›†æˆ

### GitHub Actionsé…ç½®

é¡¹ç›®å·²é…ç½®äº†å®Œæ•´çš„CI/CDæµç¨‹ï¼ŒåŒ…å«ä¸¤ç§Forgeæµ‹è¯•æ–¹å¼ï¼š

**1. åŸå§‹çŸ©é˜µæµ‹è¯•**
- Jobåç§°ï¼š`forge-tests`
- è¿è¡Œæ–¹å¼ï¼šä¸ºæ¯ä¸ªåˆçº¦åŒ…å•ç‹¬è¿è¡Œæµ‹è¯•
- ç”¨é€”ï¼šè¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Šå’Œåˆ†ç¦»çš„æµ‹è¯•ç»“æœ

**2. ç»Ÿä¸€æµ‹è¯•ï¼ˆæ–°å¢ï¼‰**
- Jobåç§°ï¼š`forge-tests-unified`
- è¿è¡Œæ–¹å¼ï¼šè‡ªåŠ¨å¯åŠ¨HardhatèŠ‚ç‚¹ï¼Œè¿è¡Œæ‰€æœ‰æµ‹è¯•
- å‘½ä»¤ï¼š`yarn test:forge:auto`
- ç‰¹ç‚¹ï¼šæ¨¡æ‹ŸçœŸå®çš„å¼€å‘ç¯å¢ƒ

### CIç¯å¢ƒå˜é‡

```yaml
env:
    MAINNET_RPC_URL: http://localhost:8545  # æŒ‡å‘æœ¬åœ°HardhatèŠ‚ç‚¹
```

### ä¾èµ–å…³ç³»

```yaml
forge-tests-unified:
    needs: [setup, build]  # ç¡®ä¿ä¾èµ–å®‰è£…å’Œæ„å»ºå®Œæˆ
    timeout-minutes: 30    # è¶³å¤Ÿçš„æ—¶é—´è¿è¡Œæ‰€æœ‰æµ‹è¯•
```

### ç¼“å­˜ç­–ç•¥

CIä½¿ç”¨å¤šå±‚ç¼“å­˜ä¼˜åŒ–æ„å»ºæ—¶é—´ï¼š
- **Node.jsä¾èµ–**ï¼šç¼“å­˜`node_modules`å’Œyarnç¼“å­˜
- **Foundryç¼–è¯‘**ï¼šç¼“å­˜åˆçº¦ç¼–è¯‘ç»“æœ
- **æ„å»ºäº§ç‰©**ï¼šç¼“å­˜TypeScriptç¼–è¯‘ç»“æœ

### æœ¬åœ°CIæµ‹è¯•

æ¨¡æ‹ŸCIç¯å¢ƒè¿è¡Œæµ‹è¯•ï¼š

```bash
# å®‰è£…ä¾èµ–
yarn install --frozen-lockfile

# æ„å»ºé¡¹ç›®
yarn build

# è¿è¡Œç»Ÿä¸€æµ‹è¯•
yarn test:forge:auto
```

---

*æœ¬æ–‡æ¡£ä¼šéšç€é¡¹ç›®å‘å±•æŒç»­æ›´æ–°ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ç›¸å…³åŒ…çš„READMEæˆ–æäº¤issueã€‚*