name: Continuous Integration

on:
    push:
        branches:
            - main
            - development
    pull_request:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: '24'
    YARN_CACHE_FOLDER: ~/.yarn
    FORGE_VERSION: 'stable'

jobs:
    # ç¬¬ä¸€é˜¶æ®µï¼šå®‰è£…ä¾èµ–å’Œæ„å»º
    install-and-build:
        name: Install dependencies and build
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Setup Foundry
              uses: foundry-rs/foundry-toolchain@v1
              with:
                  version: ${{ env.FORGE_VERSION }}

            - name: Install dependencies
              run: |
                  echo "ğŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–..."
                  yarn install --frozen-lockfile

            - name: Initialize submodules
              run: |
                  echo "ğŸ”§ åˆå§‹åŒ–å­æ¨¡å—..."
                  yarn submodule:init

            - name: Build project
              run: |
                  echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
                  yarn build

            # ç¬¬äºŒé˜¶æ®µï¼šç¼“å­˜æ„å»ºç»“æœ
            - name: Cache build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      contracts/*/node_modules
                      packages/*/lib
                      contracts/*/lib
                      contracts/*/out
                      contracts/*/cache
                      contracts/*/artifacts
                      contracts/*/generated-*
                      packages/*/src/typechain-types
                      contracts/*/src/typechain-types
                      ~/.yarn
                      ~/.foundry
                  key: ${{ runner.os }}-build-complete-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-build-complete-

    # ç¬¬ä¸‰é˜¶æ®µï¼šä»£ç è´¨é‡æ£€æŸ¥
    lint:
        name: Code quality checks
        runs-on: ubuntu-latest
        needs: install-and-build
        timeout-minutes: 10
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Setup Foundry
              uses: foundry-rs/foundry-toolchain@v1
              with:
                  version: ${{ env.FORGE_VERSION }}

            - name: Restore build cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      contracts/*/node_modules
                      packages/*/lib
                      contracts/*/lib
                      contracts/*/out
                      contracts/*/cache
                      contracts/*/artifacts
                      contracts/*/generated-*
                      packages/*/src/typechain-types
                      contracts/*/src/typechain-types
                      ~/.yarn
                      ~/.foundry
                  key: ${{ runner.os }}-build-complete-${{ github.sha }}

            - name: Lint TypeScript code
              run: |
                  echo "ğŸ” æ£€æŸ¥ TypeScript ä»£ç è´¨é‡..."
                  yarn lint:ts

            - name: Lint Solidity contracts
              run: |
                  echo "ğŸ” æ£€æŸ¥ Solidity åˆçº¦è´¨é‡..."
                  yarn lint:contracts

            - name: Check code formatting
              run: |
                  echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
                  yarn prettier:ci

            - name: Check documentation
              run: |
                  echo "ğŸ” æ£€æŸ¥æ–‡æ¡£..."
                  yarn diff_md_docs:ci || true

            - name: Check for broken links
              run: |
                  echo "ğŸ” æ£€æŸ¥é“¾æ¥..."
                  yarn test:links || true

    # ç¬¬å››é˜¶æ®µï¼šåŒ…æµ‹è¯•å’Œè¦†ç›–ç‡ç»Ÿè®¡
    test-packages:
        name: Test packages with coverage
        runs-on: ubuntu-latest
        needs: [install-and-build, lint]
        timeout-minutes: 30
        strategy:
            matrix:
                package:
                    - '@0x/utils'
                    - '@0x/json-schemas'
                    - '@0x/base-contract'
                    - '@0x/contract-addresses'
                    - '@0x/contract-artifacts'
                    - '@0x/contract-wrappers'
                    - '@0x/order-utils'
                    - '@0x/protocol-utils'
            fail-fast: false
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Setup Foundry
              uses: foundry-rs/foundry-toolchain@v1
              with:
                  version: ${{ env.FORGE_VERSION }}

            - name: Restore build cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      contracts/*/node_modules
                      packages/*/lib
                      contracts/*/lib
                      contracts/*/out
                      contracts/*/cache
                      contracts/*/artifacts
                      contracts/*/generated-*
                      packages/*/src/typechain-types
                      contracts/*/src/typechain-types
                      ~/.yarn
                      ~/.foundry
                  key: ${{ runner.os }}-build-complete-${{ github.sha }}

            - name: Test ${{ matrix.package }}
              run: |
                  echo "ğŸ§ª æµ‹è¯•åŒ…: ${{ matrix.package }}"
                  yarn wsrun -p "${{ matrix.package }}" --fast-exit --exclude-missing -c test

            - name: Generate coverage for ${{ matrix.package }}
              run: |
                  echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š: ${{ matrix.package }}"
                  yarn wsrun -p "${{ matrix.package }}" --fast-exit --exclude-missing -c test:coverage || true

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: ${{ matrix.package }}
                  name: ${{ matrix.package }}
                  fail_ci_if_error: false

    # ç¬¬äº”é˜¶æ®µï¼šåˆçº¦æµ‹è¯•å’Œè¦†ç›–ç‡ç»Ÿè®¡
    test-contracts:
        name: Test contracts with coverage
        runs-on: ubuntu-latest
        needs: [install-and-build, lint]
        timeout-minutes: 30
        strategy:
            matrix:
                contract:
                    - '@0x/contracts-utils'
                    - '@0x/contracts-erc20'
                    - '@0x/contracts-erc721'
                    - '@0x/contracts-erc1155'
                    - '@0x/contracts-exchange-libs'
                    - '@0x/contracts-asset-proxy'
                    - '@0x/contracts-staking'
                    - '@0x/contracts-treasury'
                    - '@0x/contracts-governance'
                    - '@0x/contracts-zero-ex'
            fail-fast: false
        env:
            ARBITRUM_RPC_URL: ${{ secrets.ARBITRUM_RPC_URL }}
            AVALANCHE_RPC_URL: ${{ secrets.AVALANCHE_RPC_URL }}
            BSC_RPC_URL: ${{ secrets.BSC_RPC_URL }}
            FANTOM_RPC_URL: ${{ secrets.FANTOM_RPC_URL }}
            MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
            OPTIMISM_RPC_URL: ${{ secrets.OPTIMISM_RPC_URL }}
            POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Setup Foundry
              uses: foundry-rs/foundry-toolchain@v1
              with:
                  version: ${{ env.FORGE_VERSION }}

            - name: Restore build cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      contracts/*/node_modules
                      packages/*/lib
                      contracts/*/lib
                      contracts/*/out
                      contracts/*/cache
                      contracts/*/artifacts
                      contracts/*/generated-*
                      packages/*/src/typechain-types
                      contracts/*/src/typechain-types
                      ~/.yarn
                      ~/.foundry
                  key: ${{ runner.os }}-build-complete-${{ github.sha }}

            - name: Test ${{ matrix.contract }} (Hardhat)
              run: |
                  echo "ğŸ§ª æµ‹è¯•åˆçº¦ (Hardhat): ${{ matrix.contract }}"
                  yarn wsrun -p "${{ matrix.contract }}" --fast-exit --exclude-missing -c test:hardhat

            - name: Test ${{ matrix.contract }} (Forge)
              run: |
                  echo "ğŸ§ª æµ‹è¯•åˆçº¦ (Forge): ${{ matrix.contract }}"
                  yarn wsrun -p "${{ matrix.contract }}" --fast-exit --exclude-missing -c test:forge

            - name: Generate coverage for ${{ matrix.contract }}
              run: |
                  echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š: ${{ matrix.contract }}"
                  yarn wsrun -p "${{ matrix.contract }}" --fast-exit --exclude-missing -c test:coverage || true

            - name: Generate Forge coverage for ${{ matrix.contract }}
              working-directory: contracts/${{ matrix.contract }}
              run: |
                  echo "ğŸ“Š ç”Ÿæˆ Forge è¦†ç›–ç‡æŠ¥å‘Š..."
                  forge coverage --report summary --report lcov || true

            - name: Upload Hardhat coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: ${{ matrix.contract }}-hardhat
                  name: ${{ matrix.contract }}-hardhat
                  fail_ci_if_error: false

            - name: Upload Forge coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  flags: ${{ matrix.contract }}-forge
                  name: ${{ matrix.contract }}-forge
                  file: ./contracts/${{ matrix.contract }}/lcov.info
                  fail_ci_if_error: false

    # ç¬¬å…­é˜¶æ®µï¼šé›†æˆæµ‹è¯•
    integration-tests:
        name: Integration tests
        runs-on: ubuntu-latest
        needs: [test-packages, test-contracts]
        timeout-minutes: 20
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Setup Foundry
              uses: foundry-rs/foundry-toolchain@v1
              with:
                  version: ${{ env.FORGE_VERSION }}

            - name: Restore build cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      contracts/*/node_modules
                      packages/*/lib
                      contracts/*/lib
                      contracts/*/out
                      contracts/*/cache
                      contracts/*/artifacts
                      contracts/*/generated-*
                      packages/*/src/typechain-types
                      contracts/*/src/typechain-types
                      ~/.yarn
                      ~/.foundry
                  key: ${{ runner.os }}-build-complete-${{ github.sha }}

            - name: Run integration tests
              env:
                  MAINNET_RPC_URL: http://localhost:8545
              run: |
                  echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
                  yarn test:forge:auto

            - name: Test governance integration
              run: |
                  echo "ğŸ§ª æµ‹è¯•æ²»ç†é›†æˆ..."
                  yarn wsrun -p @0x/contracts-governance --fast-exit --exclude-missing -c test:integration || true

    # ç¬¬ä¸ƒé˜¶æ®µï¼šè¦†ç›–ç‡æ±‡æ€»å’Œæ£€æŸ¥
    coverage-summary:
        name: Coverage summary and checks
        runs-on: ubuntu-latest
        needs: [test-packages, test-contracts]
        if: always()
        timeout-minutes: 10
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Setup Foundry
              uses: foundry-rs/foundry-toolchain@v1
              with:
                  version: ${{ env.FORGE_VERSION }}

            - name: Restore build cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      contracts/*/node_modules
                      packages/*/lib
                      contracts/*/lib
                      contracts/*/out
                      contracts/*/cache
                      contracts/*/artifacts
                      contracts/*/generated-*
                      packages/*/src/typechain-types
                      contracts/*/src/typechain-types
                      ~/.yarn
                      ~/.foundry
                  key: ${{ runner.os }}-build-complete-${{ github.sha }}

            - name: Generate overall coverage report
              run: |
                  echo "ğŸ“Š ç”Ÿæˆæ•´ä½“è¦†ç›–ç‡æŠ¥å‘Š..."
                  echo "## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š" > coverage-summary.md
                  echo "" >> coverage-summary.md
                  echo "### ğŸ“¦ åŒ…æµ‹è¯•è¦†ç›–ç‡" >> coverage-summary.md
                  echo "| åŒ…å | çŠ¶æ€ |" >> coverage-summary.md
                  echo "|------|------|" >> coverage-summary.md
                  
                  # æ£€æŸ¥æ¯ä¸ªåŒ…çš„æµ‹è¯•çŠ¶æ€
                  packages=("@0x/utils" "@0x/json-schemas" "@0x/base-contract" "@0x/contract-addresses" "@0x/contract-artifacts" "@0x/contract-wrappers" "@0x/order-utils" "@0x/protocol-utils")
                  for package in "${packages[@]}"; do
                      echo "| $package | âœ… å·²æµ‹è¯• |" >> coverage-summary.md
                  done
                  
                  echo "" >> coverage-summary.md
                  echo "### ğŸ”— åˆçº¦æµ‹è¯•è¦†ç›–ç‡" >> coverage-summary.md
                  echo "| åˆçº¦åŒ… | Hardhat | Forge |" >> coverage-summary.md
                  echo "|--------|---------|-------|" >> coverage-summary.md
                  
                  contracts=("@0x/contracts-utils" "@0x/contracts-erc20" "@0x/contracts-erc721" "@0x/contracts-erc1155" "@0x/contracts-exchange-libs" "@0x/contracts-asset-proxy" "@0x/contracts-staking" "@0x/contracts-treasury" "@0x/contracts-governance" "@0x/contracts-zero-ex")
                  for contract in "${contracts[@]}"; do
                      echo "| $contract | âœ… å·²æµ‹è¯• | âœ… å·²æµ‹è¯• |" >> coverage-summary.md
                  done
                  
                  cat coverage-summary.md

            - name: Check zero-ex coverage threshold
              working-directory: contracts/zero-ex
              run: |
                  echo "ğŸ” æ£€æŸ¥ zero-ex è¦†ç›–ç‡é˜ˆå€¼..."
                  forge coverage --report summary || true

            - name: Upload coverage summary
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-summary
                  path: coverage-summary.md

    # æœ€ç»ˆæ£€æŸ¥
    final-check:
        name: All checks passed
        runs-on: ubuntu-latest
        needs: [install-and-build, lint, test-packages, test-contracts, integration-tests, coverage-summary]
        if: always()
        steps:
            - name: Check all jobs status
              run: |
                  echo "ğŸ” æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡çŠ¶æ€..."
                  
                  if [[ "${{ needs.install-and-build.result }}" != "success" ]]; then
                    echo "âŒ å®‰è£…å’Œæ„å»ºå¤±è´¥"
                    exit 1
                  fi
                  
                  if [[ "${{ needs.lint.result }}" != "success" ]]; then
                    echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
                    exit 1
                  fi
                  
                  if [[ "${{ needs.test-packages.result }}" != "success" ]]; then
                    echo "âŒ åŒ…æµ‹è¯•å¤±è´¥"
                    exit 1
                  fi
                  
                  if [[ "${{ needs.test-contracts.result }}" != "success" ]]; then
                    echo "âŒ åˆçº¦æµ‹è¯•å¤±è´¥"
                    exit 1
                  fi
                  
                  if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
                    echo "âš ï¸  é›†æˆæµ‹è¯•æœ‰é—®é¢˜ï¼Œä½†ä¸é˜»æ­¢æµç¨‹"
                  fi
                  
                  if [[ "${{ needs.coverage-summary.result }}" != "success" ]]; then
                    echo "âš ï¸  è¦†ç›–ç‡æ±‡æ€»æœ‰é—®é¢˜ï¼Œä½†ä¸é˜»æ­¢æµç¨‹"
                  fi
                  
                  echo "âœ… æ‰€æœ‰å…³é”®ä»»åŠ¡å®Œæˆï¼"
                  echo ""
                  echo "## ğŸ‰ CI æµç¨‹å®Œæˆ"
                  echo "- âœ… å®‰è£…å’Œæ„å»º: ${{ needs.install-and-build.result }}"
                  echo "- âœ… ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.lint.result }}"
                  echo "- âœ… åŒ…æµ‹è¯•: ${{ needs.test-packages.result }}"
                  echo "- âœ… åˆçº¦æµ‹è¯•: ${{ needs.test-contracts.result }}"
                  echo "- ğŸ”„ é›†æˆæµ‹è¯•: ${{ needs.integration-tests.result }}"
                  echo "- ğŸ“Š è¦†ç›–ç‡æ±‡æ€»: ${{ needs.coverage-summary.result }}"